if 'custom' not in globals():
    from mage_ai.data_preparation.decorators import custom
if 'test' not in globals():
    from mage_ai.data_preparation.decorators import test

from mage_ai.data_preparation.shared.secrets import get_secret_value
import snowflake.connector

@custom
def transform_custom(*args, **kwargs):
    """
    Conecta a Snowflake usando Secrets y hace un SELECT de verificaci√≥n.
    Forzamos timeouts para evitar bloqueos largos.
    """
    print("üîç Intentando conectar con Snowflake (timeouts cortos)...")

    user = get_secret_value('SNOWFLAKE_USER')
    password = get_secret_value('SNOWFLAKE_PASSWORD')
    account = get_secret_value('SNOWFLAKE_ACCOUNT')  # p.ej. xpc24435.us-east-1
    role = get_secret_value('SNOWFLAKE_ROLE')
    warehouse = get_secret_value('SNOWFLAKE_WAREHOUSE')
    database = get_secret_value('SNOWFLAKE_DB')
    schema = get_secret_value('SNOWFLAKE_SCHEMA_BRONZE')

    # Sugerencia: verifica visualmente que SNOWFLAKE_ACCOUNT sea EXACTAMENTE 'xpc24435.us-east-1'
    print(f"Cuenta: {account}, Usuario: {user}, DB: {database}, Schema: {schema}, WH: {warehouse}, Rol: {role}")

    conn = None
    cur = None
    try:
        conn = snowflake.connector.connect(
            user=user,
            password=password,
            account=account,              # sin '.snowflakecomputing.com'
            role=role,
            warehouse=warehouse,
            database=database,
            schema=schema,
            login_timeout=20,             # segundos
            network_timeout=20,           # segundos
            client_session_keep_alive=False,
            authenticator='snowflake',    # fuerza password auth est√°ndar
        )

        cur = conn.cursor()
        cur.execute("SELECT CURRENT_VERSION(), CURRENT_ROLE(), CURRENT_DATABASE(), CURRENT_SCHEMA();")
        v, r, d, s = cur.fetchone()

        print("‚úÖ Conexi√≥n exitosa a Snowflake!")
        print(f"Versi√≥n: {v}")
        print(f"Rol actual: {r}")
        print(f"Base de datos: {d}")
        print(f"Esquema: {s}")
        return {'version': v, 'role': r, 'database': d, 'schema': s}

    except Exception as e:
        print("‚ùå Error al conectar a Snowflake:")
        print(repr(e))
        # Si sigue colg√°ndose en OCSP en tu red, como prueba temporal podr√≠amos usar insecure_mode=True
        # (no recomendado permanente). Av√≠same si el error persiste con timeout y lo activamos solo para la prueba.
        raise
    finally:
        try:
            if cur is not None:
                cur.close()
            if conn is not None:
                conn.close()
        except Exception:
            pass

@test
def test_output(output, *args) -> None:
    assert output is not None, 'El output es None; la conexi√≥n no devolvi√≥ datos.'
